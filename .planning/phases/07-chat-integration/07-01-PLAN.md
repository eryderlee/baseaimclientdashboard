---
phase: 07-chat-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - lib/schemas/settings.ts
  - lib/dal.ts
  - app/admin/settings/actions.ts
  - app/admin/settings/page.tsx
  - lib/utils/chat-links.ts
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to /admin/settings and see chat configuration form"
    - "Admin can enter WhatsApp number and Telegram username and save successfully"
    - "Settings persist in database and survive page refresh"
    - "Invalid phone number format shows validation error"
    - "Invalid Telegram username format shows validation error"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "Settings model with whatsappNumber and telegramUsername fields"
      contains: "model Settings"
    - path: "lib/schemas/settings.ts"
      provides: "Zod validation schema for chat settings"
      exports: ["chatSettingsSchema"]
    - path: "lib/dal.ts"
      provides: "getChatSettings DAL function"
      contains: "getChatSettings"
    - path: "app/admin/settings/actions.ts"
      provides: "Server Action for updating chat settings"
      exports: ["updateChatSettings"]
    - path: "app/admin/settings/page.tsx"
      provides: "Admin settings page with chat configuration form"
    - path: "lib/utils/chat-links.ts"
      provides: "URL generation utilities for WhatsApp and Telegram"
      exports: ["generateWhatsAppLink", "generateTelegramLink", "createClientMessage"]
  key_links:
    - from: "app/admin/settings/page.tsx"
      to: "app/admin/settings/actions.ts"
      via: "Server Action form submission"
      pattern: "updateChatSettings"
    - from: "app/admin/settings/actions.ts"
      to: "prisma.settings"
      via: "Prisma upsert"
      pattern: "prisma\\.settings"
    - from: "app/admin/settings/page.tsx"
      to: "lib/dal.ts"
      via: "Server component data fetch"
      pattern: "getChatSettings"
---

<objective>
Add Settings model to database, create admin settings page for configuring WhatsApp number and Telegram username, and build URL generation utilities for chat links.

Purpose: Admin needs to configure contact details that clients will use to reach BaseAim via WhatsApp/Telegram. This plan creates the entire backend + admin UI for that configuration.
Output: Working admin settings page at /admin/settings where admin can save WhatsApp number and Telegram username, plus utility functions for generating chat URLs.
</objective>

<execution_context>
@C:\Users\eryde\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\eryde\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-chat-integration/07-RESEARCH.md

Key existing patterns to follow:
- @prisma/schema.prisma (existing models use @@map for table names, cuid() IDs, createdAt/updatedAt)
- @lib/dal.ts (DAL pattern: cache() wrapped, verifySession() for auth, admin-only functions check userRole)
- @app/admin/actions.ts (Server Actions pattern: 'use server', verifySession, Zod validation, revalidatePath)
- @lib/schemas/client.ts (Zod schema pattern)
- @components/admin/admin-nav.tsx (already has /admin/settings nav link)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Settings model, Zod schema, DAL function, and chat URL utilities</name>
  <files>
    prisma/schema.prisma
    lib/schemas/settings.ts
    lib/dal.ts
    lib/utils/chat-links.ts
  </files>
  <action>
    1. Add Settings model to prisma/schema.prisma (at the end, after Activity model):
       - id: String @id @default(cuid())
       - whatsappNumber: String? (digits only, international format without +)
       - telegramUsername: String? (without @ prefix)
       - createdAt: DateTime @default(now())
       - updatedAt: DateTime @updatedAt
       - @@map("settings")
       This is a singleton table (one row for global app settings).

    2. Run `npx prisma db push` to apply schema changes.

    3. Create lib/schemas/settings.ts with Zod validation:
       - chatSettingsSchema with:
         - whatsappNumber: z.string().regex(/^\d{10,15}$/, 'Phone number must be 10-15 digits').optional().or(z.literal(''))
         - telegramUsername: z.string().regex(/^[a-zA-Z0-9_]{5,32}$/, 'Username must be 5-32 characters (letters, numbers, underscores)').optional().or(z.literal(''))
       - Export the schema and inferred type ChatSettingsData

    4. Add getChatSettings to lib/dal.ts:
       - Wrap with cache()
       - Use prisma.settings.findFirst() (no auth check needed - settings are public for clients to see chat buttons)
       - Return { whatsappNumber, telegramUsername } or null
       - Import at top of file alongside other imports

    5. Create lib/utils/chat-links.ts with three pure functions:
       - generateWhatsAppLink(phoneNumber: string, message: string): string
         - Clean phone: remove all non-digit characters
         - Return `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`
       - generateTelegramLink(username: string): string
         - Clean username: remove leading @ if present
         - Return `https://t.me/${cleanUsername}`
         - Note: Telegram does NOT support pre-filled messages for regular users (only bots)
       - createClientMessage(clientName: string, companyName: string): string
         - Return "Hello! I'm {clientName} from {companyName}. I'd like to discuss my project."
  </action>
  <verify>
    - `npx prisma db push` succeeds without errors
    - `npx tsc --noEmit` passes (no TypeScript errors)
    - Manually verify schema.prisma contains model Settings with correct fields
  </verify>
  <done>
    Settings model exists in database. Zod schema validates phone/username formats. DAL function fetches settings. Chat URL utilities generate correct WhatsApp and Telegram links.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin settings page with chat configuration form and Server Action</name>
  <files>
    app/admin/settings/actions.ts
    app/admin/settings/page.tsx
  </files>
  <action>
    1. Create app/admin/settings/actions.ts:
       - 'use server' directive
       - Import verifySession from @/lib/dal, prisma from @/lib/prisma, chatSettingsSchema from @/lib/schemas/settings
       - Import revalidatePath from next/cache
       - updateChatSettings(formData: FormData) function:
         - Verify admin role via verifySession()
         - Extract whatsappNumber and telegramUsername from formData
         - Validate with chatSettingsSchema.safeParse()
         - Return { error, errors } on validation failure
         - Use prisma.settings.upsert() pattern:
           - where: find first settings record (use findFirst to get ID, then upsert)
           - Actually simpler: findFirst, then update if exists, create if not (same pattern as research suggested)
         - revalidatePath('/admin/settings')
         - revalidatePath('/dashboard') (so client chat buttons update)
         - Return { success: true }
       Follow exact pattern from app/admin/actions.ts (verifySession, Zod validation, error handling, revalidatePath).

    2. Create app/admin/settings/page.tsx as an async server component page:
       - Import getChatSettings from @/lib/dal
       - Fetch current settings: const settings = await getChatSettings()
       - Render a clean admin-style page with:
         - Page header: "Settings" title, "Configure application settings" description
         - Card with "Chat Integration" title and description "Configure WhatsApp and Telegram contact details for client chat buttons"
         - Form with:
           - WhatsApp Number field: text input, placeholder "1234567890", helper text "Enter phone number in international format (digits only, no + or spaces). Example: 12025551234"
           - Telegram Username field: text input, placeholder "baseaim_support", helper text "Enter Telegram username without @ symbol"
           - Submit button "Save Settings"
         - Use a client component for the form (ChatSettingsForm) that:
           - Uses useActionState (React 19) or useTransition for the Server Action
           - Shows validation errors inline under fields
           - Shows success toast via sonner after save
           - Pre-fills form with current settings values
       - Style consistently with existing admin pages (neutral colors, clean cards, no gradient effects)
       - The admin nav already links to /admin/settings (see admin-nav.tsx line 38)
  </action>
  <verify>
    - Navigate to /admin/settings (while logged in as admin) and see the chat configuration form
    - Enter a valid WhatsApp number (e.g., "12025551234") and Telegram username (e.g., "baseaim_support"), click Save
    - Page refreshes with saved values pre-filled
    - Enter invalid phone number (e.g., "abc") and see validation error
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    Admin can navigate to /admin/settings, enter WhatsApp number and Telegram username, save successfully, and see values persist on refresh. Validation errors display for invalid input.
  </done>
</task>

</tasks>

<verification>
1. Settings model exists in database: `npx prisma db push` completes successfully
2. Admin settings page loads at /admin/settings with chat configuration form
3. Saving valid settings works and persists across refresh
4. Invalid input shows validation errors (bad phone format, bad username format)
5. TypeScript compiles without errors: `npx tsc --noEmit`
</verification>

<success_criteria>
- Settings model in Prisma schema with whatsappNumber and telegramUsername
- Admin can save and retrieve chat settings through /admin/settings page
- Zod validation prevents invalid phone numbers and usernames
- Chat URL utility functions ready for client-side use in Plan 02
- getChatSettings DAL function available for Plan 02 to fetch settings
</success_criteria>

<output>
After completion, create `.planning/phases/07-chat-integration/07-01-SUMMARY.md`
</output>
