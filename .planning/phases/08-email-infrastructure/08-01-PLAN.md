---
phase: 08-email-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - .env
  - lib/resend.ts
  - lib/email.ts
  - emails/components/email-layout.tsx
  - emails/welcome-email.tsx
  - app/admin/actions.ts
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery API for transactional emails"
    env_vars:
      - name: RESEND_API_KEY
        source: "https://resend.com/api-keys — create account, copy API key"
    dashboard_config:
      - task: "Verify sending domain (baseaim.com) for production deliverability"
        location: "Resend Dashboard -> Domains -> Add Domain -> add DNS records"

must_haves:
  truths:
    - "Welcome email is sent when admin creates a new client"
    - "Email contains client name, login email, temporary password, and login link"
    - "All emails use consistent BaseAim branding (logo, colors, footer)"
    - "Email send failures do not break client creation flow"
  artifacts:
    - path: "lib/resend.ts"
      provides: "Configured Resend client singleton"
      exports: ["resend"]
    - path: "lib/email.ts"
      provides: "Email sending utility with error handling and retry"
      exports: ["sendEmail"]
    - path: "emails/components/email-layout.tsx"
      provides: "Shared email layout with BaseAim branding"
      exports: ["EmailLayout"]
    - path: "emails/welcome-email.tsx"
      provides: "Welcome email template with credentials"
      exports: ["WelcomeEmail"]
    - path: "app/admin/actions.ts"
      provides: "createClient action with welcome email trigger"
  key_links:
    - from: "app/admin/actions.ts"
      to: "lib/email.ts"
      via: "sendWelcomeEmail call after transaction"
      pattern: "sendWelcomeEmail"
    - from: "lib/email.ts"
      to: "lib/resend.ts"
      via: "resend.emails.send"
      pattern: "resend\\.emails\\.send"
    - from: "emails/welcome-email.tsx"
      to: "emails/components/email-layout.tsx"
      via: "EmailLayout wrapper"
      pattern: "EmailLayout"
---

<objective>
Set up Resend + React Email infrastructure and implement welcome email for new clients.

Purpose: Email infrastructure enables all transactional email features across the dashboard. The welcome email (EMAIL-01) is the first critical email — sent when admin creates a new client account with their login credentials.

Output: Working email infrastructure (Resend client, send utility, branded layout) and welcome email that fires automatically when a client is created via the admin panel.
</objective>

<execution_context>
@C:\Users\eryde\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\eryde\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-email-infrastructure/08-RESEARCH.md
@app/admin/actions.ts
@prisma/schema.prisma
@lib/prisma.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create email infrastructure</name>
  <files>
    package.json
    lib/resend.ts
    lib/email.ts
    emails/components/email-layout.tsx
    .env
  </files>
  <action>
1. Install dependencies: `npm install resend @react-email/components @react-email/render`

2. Create `lib/resend.ts` — Resend client singleton:
   - Import Resend from 'resend'
   - Export configured instance using `process.env.RESEND_API_KEY`
   - Add runtime check: if no API key, log warning but don't crash (allows dev without key)

3. Create `lib/email.ts` — Email sending utility:
   - Import resend client from lib/resend
   - Import render from @react-email/render
   - Export `sendEmail` function that accepts: { to, subject, react (ReactElement), from? }
   - Use render() to convert React component to HTML string, then pass to resend.emails.send
   - Default `from` to `BaseAim <no-reply@baseaim.com>` (configurable via env RESEND_FROM_EMAIL)
   - Wrap in try/catch, return `{ success: boolean, emailId?: string, error?: string }`
   - Log errors with console.error but never throw (email failures should not crash calling code)
   - Export `sendWelcomeEmail` function that accepts { clientName, email, temporaryPassword } and calls sendEmail with WelcomeEmail template and subject "Welcome to BaseAim - Your Account is Ready"

4. Create `emails/components/email-layout.tsx` — Shared branded layout:
   - Use @react-email/components: Html, Head, Body, Container, Img, Hr, Text, Link, Preview
   - Props: { children, previewText? }
   - Header: BaseAim logo (use `${process.env.NEXT_PUBLIC_APP_URL}/logo-black.png`), 120px width
   - Horizontal rule separator after header
   - Children slot for email content
   - Footer: horizontal rule, "© 2026 BaseAim. All rights reserved." centered, small gray text
   - Footer links: Dashboard link, Settings link
   - Body styles: white background, system font stack, max-width 600px container centered
   - Use ONLY inline styles (no Tailwind — email clients don't support it reliably). Use pixel values, no rem/em.

5. Add to `.env` (append, don't overwrite existing):
   - `RESEND_API_KEY=re_placeholder_replace_me`
   - `RESEND_FROM_EMAIL=BaseAim <no-reply@baseaim.com>`
  </action>
  <verify>
    - `npm ls resend` shows installed
    - `npm ls @react-email/components` shows installed
    - Files exist: lib/resend.ts, lib/email.ts, emails/components/email-layout.tsx
    - TypeScript compiles: `npx tsc --noEmit` passes (or at least no errors in new files)
  </verify>
  <done>Resend client, email send utility, and branded email layout component exist and compile without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create welcome email template and wire into client creation</name>
  <files>
    emails/welcome-email.tsx
    app/admin/actions.ts
  </files>
  <action>
1. Create `emails/welcome-email.tsx` — Welcome email template:
   - Props interface: { clientName: string, email: string, temporaryPassword: string, loginUrl: string }
   - Wrap in EmailLayout with previewText="Welcome to BaseAim - Your account is ready"
   - Content:
     - Heading: "Welcome to BaseAim, {clientName}!"
     - Paragraph: "Your client dashboard account has been created. Here are your login credentials:"
     - Credentials box (light gray background, padded): Email label + value, Password label + value
     - Warning text: "Please log in and change your password as soon as possible."
     - CTA Button: "Log In to Dashboard" linking to loginUrl — black background, white text, 12px 24px padding, 4px border radius
     - Footer note: "If you didn't expect this email, please contact us."
   - All styles inline using pixel values. No flexbox, no grid. Simple stacking layout.
   - Export as default AND named export

2. Modify `app/admin/actions.ts` — Wire welcome email into createClient:
   - Import sendWelcomeEmail from '@/lib/email'
   - After the successful transaction (after `await prisma.$transaction(...)` completes), call:
     ```
     sendWelcomeEmail({ clientName: name, email, temporaryPassword: password })
     ```
   - IMPORTANT: Do NOT await the email send in a way that blocks the response. Use fire-and-forget pattern:
     ```
     // Fire and forget - don't block client creation on email delivery
     sendWelcomeEmail({ clientName: name, email, temporaryPassword: password })
       .catch((err) => console.error('Welcome email failed:', err))
     ```
   - The original password (before hashing) is available in the validated `password` variable — pass it as temporaryPassword
   - Do NOT change the existing return behavior. Client creation succeeds regardless of email status.
  </action>
  <verify>
    - File exists: emails/welcome-email.tsx
    - `npx tsc --noEmit` passes
    - In app/admin/actions.ts, grep for "sendWelcomeEmail" confirms it's called after transaction
    - Build succeeds: `npm run build` (may have warnings but no errors in our files)
  </verify>
  <done>Welcome email template renders client credentials with BaseAim branding, and createClient action fires welcome email after successful client creation without blocking the response</done>
</task>

</tasks>

<verification>
- `npm ls resend @react-email/components @react-email/render` — all installed
- All new files exist and compile: lib/resend.ts, lib/email.ts, emails/components/email-layout.tsx, emails/welcome-email.tsx
- app/admin/actions.ts contains sendWelcomeEmail call after transaction
- `npm run build` completes without errors in new/modified files
- Email send is fire-and-forget (does not block createClient response)
</verification>

<success_criteria>
- EMAIL-01 (welcome email) is implemented end-to-end: template + trigger
- EMAIL-07 (professional templates with branding) partially satisfied: layout + welcome template
- EMAIL-08 (Resend configuration) partially satisfied: client configured, domain verification is user_setup
- Email infrastructure is reusable for all future email types (password reset, invoice, payment, document)
</success_criteria>

<output>
After completion, create `.planning/phases/08-email-infrastructure/08-01-SUMMARY.md`
</output>
