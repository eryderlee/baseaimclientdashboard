---
phase: 08-email-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - prisma/schema.prisma
  - emails/password-reset.tsx
  - emails/invoice-created.tsx
  - emails/payment-confirmation.tsx
  - emails/document-uploaded.tsx
  - lib/email.ts
  - app/(auth)/reset-password/page.tsx
  - app/(auth)/reset-password/[token]/page.tsx
  - app/actions/auth.ts
autonomous: true

must_haves:
  truths:
    - "User can request a password reset from the login page"
    - "User receives email with a secure reset link that expires in 60 minutes"
    - "User can set a new password via the reset link"
    - "Expired or used tokens are rejected with clear error message"
    - "Email templates exist for invoice, payment, and document notifications (ready for Phase 9/10)"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "PasswordResetToken model"
      contains: "model PasswordResetToken"
    - path: "emails/password-reset.tsx"
      provides: "Password reset email template"
      exports: ["PasswordResetEmail"]
    - path: "emails/invoice-created.tsx"
      provides: "Invoice notification email template"
      exports: ["InvoiceCreatedEmail"]
    - path: "emails/payment-confirmation.tsx"
      provides: "Payment confirmation email template"
      exports: ["PaymentConfirmationEmail"]
    - path: "emails/document-uploaded.tsx"
      provides: "Document uploaded email template"
      exports: ["DocumentUploadedEmail"]
    - path: "app/actions/auth.ts"
      provides: "Password reset Server Actions"
      exports: ["requestPasswordReset", "resetPassword"]
    - path: "app/(auth)/reset-password/page.tsx"
      provides: "Request password reset page"
    - path: "app/(auth)/reset-password/[token]/page.tsx"
      provides: "Set new password page"
  key_links:
    - from: "app/(auth)/reset-password/page.tsx"
      to: "app/actions/auth.ts"
      via: "requestPasswordReset Server Action"
      pattern: "requestPasswordReset"
    - from: "app/actions/auth.ts"
      to: "lib/email.ts"
      via: "sendPasswordResetEmail"
      pattern: "sendPasswordResetEmail"
    - from: "app/actions/auth.ts"
      to: "prisma"
      via: "PasswordResetToken create/findUnique/delete"
      pattern: "passwordResetToken"
---

<objective>
Implement password reset flow with email and create remaining email templates for future phases.

Purpose: Password reset (EMAIL-02) is critical for client self-service. The remaining templates (EMAIL-03, EMAIL-04, EMAIL-05) are built now so Phase 9 (Drive) and Phase 10 (Stripe) can simply call the send functions without building templates.

Output: Complete password reset flow (request page, email, token verification, new password page) and ready-to-use email templates for invoice, payment, and document notifications.
</objective>

<execution_context>
@C:\Users\eryde\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\eryde\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-email-infrastructure/08-RESEARCH.md
@.planning/phases/08-email-infrastructure/08-01-SUMMARY.md
@prisma/schema.prisma
@lib/email.ts
@emails/components/email-layout.tsx
@app/(auth)/login/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Password reset flow — schema, actions, pages, and email</name>
  <files>
    prisma/schema.prisma
    emails/password-reset.tsx
    app/actions/auth.ts
    app/(auth)/reset-password/page.tsx
    app/(auth)/reset-password/[token]/page.tsx
    lib/email.ts
  </files>
  <action>
1. Add PasswordResetToken model to `prisma/schema.prisma`:
   ```
   model PasswordResetToken {
     id        String   @id @default(cuid())
     email     String
     token     String   @unique
     expiresAt DateTime
     createdAt DateTime @default(now())

     @@map("password_reset_tokens")
     @@index([email])
     @@index([token])
   }
   ```
   Run `npx prisma db push` after adding the model.

2. Create `emails/password-reset.tsx`:
   - Props: { resetUrl: string, expiresInMinutes: number }
   - Wrap in EmailLayout with previewText="Reset your password"
   - Content: heading "Reset your password", explanatory text, CTA button "Reset Password" linking to resetUrl, expiry warning "{expiresInMinutes} minutes", and "If you didn't request this, ignore this email" note
   - Same inline style approach as welcome email

3. Add to `lib/email.ts`:
   - Export `sendPasswordResetEmail({ email, resetUrl })` function
   - Uses PasswordResetEmail template with 60-minute expiry text
   - Subject: "Reset Your Password - BaseAim"

4. Create `app/actions/auth.ts` — Server Actions for password reset:
   - `requestPasswordReset(formData: FormData)`:
     - Extract email from formData
     - Validate email format with Zod
     - Look up user by email in database
     - If user not found, still return success (prevent email enumeration)
     - Delete any existing tokens for this email (one active token at a time)
     - Generate secure token: `crypto.randomUUID()` (use Node crypto)
     - Create PasswordResetToken with 60-minute expiresAt
     - Call sendPasswordResetEmail with URL: `${process.env.NEXT_PUBLIC_APP_URL}/reset-password/${token}`
     - Return { success: true, message: "If an account exists with that email, a reset link has been sent." }
   - `resetPassword(token: string, formData: FormData)`:
     - Extract password and confirmPassword from formData
     - Validate: password >= 8 chars, passwords match (use Zod)
     - Find PasswordResetToken by token
     - If not found or expired (expiresAt < now), return { error: "Invalid or expired reset link" }
     - Find user by token.email
     - Hash new password with bcrypt (BEFORE any transaction)
     - In transaction: update user password, delete the token
     - Return { success: true }

5. Create `app/(auth)/reset-password/page.tsx` — Request reset page:
   - Check if (auth) route group exists. If login is at app/(auth)/login/page.tsx, use same group. If login is elsewhere, match its pattern.
   - Simple form: email input + submit button "Send Reset Link"
   - Use useActionState (React 19) or form action pattern matching existing login page
   - Show success message after submission (always positive to prevent enumeration)
   - Link back to login page
   - Style consistently with existing login page (check login page for patterns)

6. Create `app/(auth)/reset-password/[token]/page.tsx` — Set new password page:
   - Server component that validates token exists and isn't expired on load
   - If token invalid/expired: show error message with link to request new reset
   - If token valid: show form with password + confirmPassword inputs + submit button
   - Use resetPassword Server Action on submit
   - On success: show success message with link to login
   - Style consistently with login page

7. Add "Forgot password?" link to the existing login page — find the login page and add a Link to /reset-password below the password field or below the submit button.
  </action>
  <verify>
    - `npx prisma db push` succeeds (PasswordResetToken table created)
    - `npx tsc --noEmit` passes
    - Files exist: emails/password-reset.tsx, app/actions/auth.ts, app/(auth)/reset-password/page.tsx, app/(auth)/reset-password/[token]/page.tsx
    - Login page has "Forgot password?" link
    - `npm run build` succeeds
  </verify>
  <done>Complete password reset flow: user requests reset from /reset-password, receives email with tokenized link, clicks link to /reset-password/[token], sets new password. Expired tokens rejected. Login page links to reset page.</done>
</task>

<task type="auto">
  <name>Task 2: Create remaining email templates for future phases</name>
  <files>
    emails/invoice-created.tsx
    emails/payment-confirmation.tsx
    emails/document-uploaded.tsx
    lib/email.ts
  </files>
  <action>
1. Create `emails/invoice-created.tsx` (EMAIL-03 — triggered by Phase 10):
   - Props: { clientName: string, invoiceNumber: string, amount: number, currency: string, dueDate: string, viewUrl: string }
   - Wrap in EmailLayout with previewText
   - Content: "New Invoice" heading, "Hi {clientName}", invoice details box (number, amount formatted with Intl.NumberFormat, due date), CTA button "View Invoice" linking to viewUrl
   - Export as InvoiceCreatedEmail

2. Create `emails/payment-confirmation.tsx` (EMAIL-04 — triggered by Phase 10):
   - Props: { clientName: string, invoiceNumber: string, amount: number, currency: string, paidDate: string }
   - Wrap in EmailLayout
   - Content: "Payment Received" heading, "Hi {clientName}", confirmation that payment of {amount} for invoice {invoiceNumber} was received on {paidDate}, "Thank you for your payment" message, CTA button "View Dashboard"
   - Export as PaymentConfirmationEmail

3. Create `emails/document-uploaded.tsx` (EMAIL-05 — triggered by Phase 9):
   - Props: { clientName: string, documentName: string, uploadedBy: string, viewUrl: string }
   - Wrap in EmailLayout
   - Content: "New Document Available" heading, "Hi {clientName}", "{uploadedBy} uploaded a new document: {documentName}", CTA button "View Document"
   - Export as DocumentUploadedEmail

4. Add send functions to `lib/email.ts`:
   - Export `sendInvoiceCreatedEmail({ clientName, email, invoiceNumber, amount, currency, dueDate, viewUrl })` — subject: "Invoice {invoiceNumber} - {formatted amount}"
   - Export `sendPaymentConfirmationEmail({ clientName, email, invoiceNumber, amount, currency, paidDate })` — subject: "Payment Confirmed - Invoice {invoiceNumber}"
   - Export `sendDocumentUploadedEmail({ clientName, email, documentName, uploadedBy, viewUrl })` — subject: "New Document: {documentName}"
   - Each function follows same pattern as sendWelcomeEmail: render template, call sendEmail, return result

All templates use the shared EmailLayout from emails/components/email-layout.tsx for consistent branding.
  </action>
  <verify>
    - Files exist: emails/invoice-created.tsx, emails/payment-confirmation.tsx, emails/document-uploaded.tsx
    - `npx tsc --noEmit` passes
    - lib/email.ts exports all send functions: sendWelcomeEmail, sendPasswordResetEmail, sendInvoiceCreatedEmail, sendPaymentConfirmationEmail, sendDocumentUploadedEmail
    - `npm run build` succeeds
  </verify>
  <done>All email templates (EMAIL-03, EMAIL-04, EMAIL-05) exist with professional BaseAim branding and typed send functions are exported from lib/email.ts, ready for Phase 9 and Phase 10 to call</done>
</task>

</tasks>

<verification>
- PasswordResetToken model exists in schema and table is created
- Full password reset flow works: /reset-password -> email -> /reset-password/[token] -> new password
- Login page has "Forgot password?" link
- All 5 email templates exist: welcome, password-reset, invoice-created, payment-confirmation, document-uploaded
- All 5 send functions exported from lib/email.ts
- `npm run build` succeeds
- EMAIL-06 (weekly digest) intentionally deferred per research recommendation
</verification>

<success_criteria>
- EMAIL-02 (password reset) fully implemented end-to-end
- EMAIL-03, EMAIL-04, EMAIL-05 templates ready for Phases 9/10
- EMAIL-07 (professional branding) satisfied across all templates via shared EmailLayout
- All email requirements addressed except EMAIL-06 (weekly digest - deferred) and EMAIL-08 (domain verification - user_setup in Plan 01)
</success_criteria>

<output>
After completion, create `.planning/phases/08-email-infrastructure/08-02-SUMMARY.md`
</output>
