---
phase: 03-client-data-isolation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/dal.ts
  - middleware.ts
  - types/next-auth.d.ts
  - tsconfig.json
autonomous: true

must_haves:
  truths:
    - "Unauthenticated users are redirected to /login when visiting /dashboard"
    - "Session includes user role (ADMIN or CLIENT) and user id"
    - "DAL verifySession() redirects to /login if no session exists"
    - "DAL getCurrentClientId() returns clientId for CLIENT users and null for ADMIN users"
  artifacts:
    - path: "lib/dal.ts"
      provides: "Data Access Layer with session verification and client-scoped queries"
      exports: ["verifySession", "getCurrentClientId", "getMilestones"]
      contains: "server-only"
    - path: "middleware.ts"
      provides: "Route protection redirecting unauthenticated users"
      contains: "matcher"
    - path: "types/next-auth.d.ts"
      provides: "TypeScript augmentation for NextAuth session with role and id"
      contains: "declare module"
  key_links:
    - from: "lib/dal.ts"
      to: "lib/auth.ts"
      via: "import { auth } from '@/lib/auth'"
      pattern: "import.*auth.*from.*@/lib/auth"
    - from: "lib/dal.ts"
      to: "lib/prisma.ts"
      via: "import { prisma } from '@/lib/prisma'"
      pattern: "import.*prisma.*from.*@/lib/prisma"
    - from: "middleware.ts"
      to: "lib/auth.ts"
      via: "NextAuth middleware or auth() check"
      pattern: "auth|middleware"
---

<objective>
Create the authentication infrastructure for client data isolation: Data Access Layer (DAL), middleware for route protection, and NextAuth type augmentation.

Purpose: This is the foundation all other auth-related work depends on. The DAL pattern centralizes authorization logic so every page and API route gets automatic session verification and client-scoped data filtering. Middleware protects dashboard routes from unauthenticated access.

Output: lib/dal.ts, middleware.ts, types/next-auth.d.ts (updated), and server-only + zod packages installed.
</objective>

<execution_context>
@C:\Users\eryde\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\eryde\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-client-data-isolation/03-RESEARCH.md

@lib/auth.ts
@lib/prisma.ts
@prisma/schema.prisma
@lib/types/milestone.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create NextAuth type augmentation</name>
  <files>types/next-auth.d.ts, tsconfig.json</files>
  <action>
1. Install required packages:
   ```
   npm install server-only zod
   ```

2. Create `types/next-auth.d.ts` to augment NextAuth types with role and id on session:
   ```typescript
   import { DefaultSession } from "next-auth"

   declare module "next-auth" {
     interface User {
       role?: string
     }
     interface Session {
       user: {
         id: string
         role: string
       } & DefaultSession["user"]
     }
   }

   declare module "next-auth/jwt" {
     interface JWT {
       id?: string
       role?: string
     }
   }
   ```

3. Verify tsconfig.json includes the `types` directory in its include array. If not, add it. The key is that TypeScript picks up the `.d.ts` file. Check if tsconfig already has `"**/*.ts"` or similar glob that would catch `types/next-auth.d.ts`. If not, add `"types/**/*.d.ts"` to the include array.

IMPORTANT: Do NOT modify lib/auth.ts in this task. The JWT and session callbacks already include role and id correctly.
  </action>
  <verify>
- Run `npx tsc --noEmit` and confirm no type errors related to session.user.role or session.user.id
- Check node_modules/server-only and node_modules/zod exist
  </verify>
  <done>
- server-only and zod packages installed
- TypeScript recognizes session.user.role and session.user.id without type errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Data Access Layer and route-protection middleware</name>
  <files>lib/dal.ts, middleware.ts</files>
  <action>
1. Create `lib/dal.ts` following the DAL pattern from 03-RESEARCH.md:

```typescript
import 'server-only'
import { cache } from 'react'
import { redirect } from 'next/navigation'
import { auth } from '@/lib/auth'
import { prisma } from '@/lib/prisma'

export const verifySession = cache(async () => {
  const session = await auth()

  if (!session?.user?.id) {
    redirect('/login')
  }

  return {
    userId: session.user.id,
    userRole: session.user.role as 'ADMIN' | 'CLIENT',
    isAuth: true,
  }
})

export const getCurrentClientId = cache(async () => {
  const { userId, userRole } = await verifySession()

  if (userRole === 'ADMIN') {
    return null
  }

  const client = await prisma.client.findUnique({
    where: { userId },
    select: { id: true },
  })

  if (!client) {
    throw new Error('Client profile not found')
  }

  return client.id
})

export const getMilestones = cache(async () => {
  const clientId = await getCurrentClientId()

  return await prisma.milestone.findMany({
    where: clientId ? { clientId } : {},
    orderBy: { order: 'asc' },
    select: {
      id: true,
      clientId: true,
      title: true,
      description: true,
      status: true,
      progress: true,
      startDate: true,
      dueDate: true,
      completedAt: true,
      notes: true,
      order: true,
      createdAt: true,
      updatedAt: true,
    },
  })
})
```

Key points:
- `import 'server-only'` at top to prevent client-side execution
- Every function wrapped in React `cache()` to deduplicate in a single render pass
- `verifySession` redirects to /login if no session -- never returns null
- `getCurrentClientId` returns null for ADMIN (sees all), clientId for CLIENT
- `getMilestones` uses empty where `{}` for admin (returns all) and `{ clientId }` for clients
- Select includes clientId so the progress page can function correctly
- Do NOT include `client` relation in select -- only flat fields needed

2. Create `middleware.ts` in project root for route protection:

```typescript
import { auth } from '@/lib/auth'
import { NextResponse } from 'next/server'

export default auth((req) => {
  const isLoggedIn = !!req.auth
  const isOnDashboard = req.nextUrl.pathname.startsWith('/dashboard')
  const isOnLogin = req.nextUrl.pathname === '/login'
  const isOnRegister = req.nextUrl.pathname === '/register'
  const isAuthRoute = isOnLogin || isOnRegister

  // Redirect authenticated users away from auth pages
  if (isAuthRoute && isLoggedIn) {
    return NextResponse.redirect(new URL('/dashboard', req.url))
  }

  // Redirect unauthenticated users to login
  if (isOnDashboard && !isLoggedIn) {
    return NextResponse.redirect(new URL('/login', req.url))
  }

  return NextResponse.next()
})

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon\\.ico|.*\\.png$|.*\\.ico$).*)'],
}
```

IMPORTANT:
- Use the NextAuth v5 middleware pattern: `auth((req) => {...})` as default export. This wraps the middleware with auth, making `req.auth` available.
- The `matcher` excludes API routes (NextAuth handlers need to work), static files, and images.
- This is OPTIMISTIC protection only. The DAL's `verifySession()` is the real security layer. Middleware just provides better UX by redirecting early.
- Do NOT add admin route protection in middleware. Admin vs client access is handled in the DAL.
  </action>
  <verify>
- Run `npx tsc --noEmit` to confirm no type errors
- Run `npm run build` to confirm the build succeeds (middleware + DAL compile correctly)
  </verify>
  <done>
- lib/dal.ts exports verifySession, getCurrentClientId, getMilestones
- middleware.ts redirects unauthenticated /dashboard requests to /login
- middleware.ts redirects authenticated users away from /login
- Build succeeds without errors
  </done>
</task>

</tasks>

<verification>
- `npm run build` completes successfully
- `npx tsc --noEmit` passes with no errors
- lib/dal.ts contains `import 'server-only'` at top
- lib/dal.ts exports verifySession, getCurrentClientId, getMilestones
- middleware.ts exists in project root with matcher config
- types/next-auth.d.ts augments Session with id and role
</verification>

<success_criteria>
- Build passes cleanly
- DAL functions properly typed and exported
- Middleware correctly configured for route protection
- NextAuth session types include role and id
</success_criteria>

<output>
After completion, create `.planning/phases/03-client-data-isolation/03-01-SUMMARY.md`
</output>
