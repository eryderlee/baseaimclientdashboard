---
phase: 04-admin-milestone-editing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/dal.ts
  - lib/utils/progress.ts
  - app/dashboard/admin/clients/[clientId]/actions.ts
autonomous: true

must_haves:
  truths:
    - "Admin DAL functions return client list with milestones"
    - "Admin DAL functions return single client with milestones by ID"
    - "Server Action validates input with Zod and saves milestone updates in a transaction"
    - "Progress percentage auto-calculates based on status and time elapsed"
    - "In Progress milestones show time-based progress calculated from start to due date"
  artifacts:
    - path: "lib/dal.ts"
      provides: "getAllClientsWithMilestones and getClientWithMilestones functions"
      contains: "getAllClientsWithMilestones"
    - path: "lib/utils/progress.ts"
      provides: "Time-based milestone progress calculation"
      exports: ["calculateMilestoneProgress"]
    - path: "app/dashboard/admin/clients/[clientId]/actions.ts"
      provides: "updateMilestones Server Action with Zod validation"
      contains: "use server"
  key_links:
    - from: "app/dashboard/admin/clients/[clientId]/actions.ts"
      to: "lib/dal.ts"
      via: "verifySession for admin auth"
      pattern: "verifySession"
    - from: "app/dashboard/admin/clients/[clientId]/actions.ts"
      to: "prisma.milestone"
      via: "Prisma $transaction for batch update"
      pattern: "\\$transaction"
    - from: "app/dashboard/admin/clients/[clientId]/actions.ts"
      to: "lib/utils/progress.ts"
      via: "Import for progress recalculation on save"
      pattern: "calculateMilestoneProgress"
---

<objective>
Build the backend foundation for admin milestone editing: DAL functions to fetch client/milestone data with admin authorization, a time-based progress calculation utility, and a Server Action for batch milestone updates.

Purpose: The admin interface needs data access functions and mutation logic before any UI can be built. This plan creates all the server-side pieces that Plan 02's UI will consume.
Output: DAL functions for admin data access, progress utility, and validated Server Action for milestone updates.
</objective>

<execution_context>
@C:\Users\eryde\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\eryde\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-admin-milestone-editing/04-RESEARCH.md

@lib/dal.ts
@prisma/schema.prisma
@app/dashboard/admin/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add admin DAL functions and progress utility</name>
  <files>lib/dal.ts, lib/utils/progress.ts</files>
  <action>
**In `lib/dal.ts`, add two new cached functions:**

1. `getAllClientsWithMilestones` -- For admin client list. Calls `verifySession()`, checks `userRole === 'ADMIN'`, throws if not admin. Returns all clients with their user info (name, email), milestones, and computed overall progress. Use `prisma.client.findMany` with `include: { user: { select: { name, email } }, milestones: { orderBy: { order: 'asc' } } }`. Order clients by `createdAt desc`.

2. `getClientWithMilestones(clientId: string)` -- For single client milestone editing. Calls `verifySession()`, checks admin role. Returns single client with user info and all milestones ordered by `order asc`. Use `prisma.client.findUnique` with include. Throw if client not found.

Both functions must be wrapped with `cache()` from React.

**Create `lib/utils/progress.ts`:**

Export `calculateMilestoneProgress(status, startDate, dueDate)` function:
- `COMPLETED` returns 100
- `NOT_STARTED` returns 0
- `IN_PROGRESS` with both startDate and dueDate: calculate `elapsedDays / totalDays * 100`, clamp between 0 and 99 (never 100 until explicitly marked complete). Use `differenceInDays` from `date-fns`.
- `IN_PROGRESS` without dates: return 50 as fallback (midpoint estimate)
- `BLOCKED` returns 0

Export `calculateOverallProgress(milestones)` that takes an array of milestones and returns the average progress across all milestones as a rounded integer 0-100. This is used both by admin list and client dashboard.

Import types from Prisma (`MilestoneStatus`) for type safety. Do NOT use `any`.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles without errors. Check that `lib/dal.ts` exports `getAllClientsWithMilestones` and `getClientWithMilestones`. Check that `lib/utils/progress.ts` exports `calculateMilestoneProgress` and `calculateOverallProgress`.
  </verify>
  <done>
DAL has two admin-specific functions that verify admin role and return client data with milestones. Progress utility calculates time-based percentages for all milestone statuses. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Server Action for batch milestone updates</name>
  <files>app/dashboard/admin/clients/[clientId]/actions.ts</files>
  <action>
**Create `app/dashboard/admin/clients/[clientId]/actions.ts`:**

Mark with `'use server'` at top.

Define Zod schema `MilestoneUpdateSchema`:
```
z.object({
  milestones: z.array(z.object({
    id: z.string(),
    status: z.enum(['NOT_STARTED', 'IN_PROGRESS', 'COMPLETED', 'BLOCKED']),
    dueDate: z.string().nullable(),
    newNote: z.string().optional(),
  }))
})
```

Note: The `notes` field in the Prisma schema is `Json? @default("[]")` -- a JSON array of strings. The UI sends a `newNote` string (the admin's new note text). The Server Action appends this to the existing array, preserving note history. Do NOT replace the array with a single string.

Export `updateMilestones(clientId: string, rawData: unknown)` async function:

1. Call `verifySession()` from DAL, check `userRole === 'ADMIN'`. Return `{ error: 'Unauthorized' }` if not admin.
2. Validate `rawData` with `MilestoneUpdateSchema.safeParse()`. Return `{ error: 'Invalid data', errors: ... }` on failure.
3. Fetch current milestones with `prisma.milestone.findMany({ where: { clientId }, select: { id: true, status: true, startDate: true, notes: true } })` before the transaction. This is needed to: (a) determine status changes for date handling, and (b) read existing notes array for appending.
4. For each milestone in validated data, determine if startDate needs updating:
   - If status is changing TO `IN_PROGRESS` and the milestone currently has no startDate, set `startDate: new Date()`.
   - If status is changing TO `NOT_STARTED`, clear `startDate: null` and `completedAt: null`.
   - If status is changing TO `COMPLETED`, set `completedAt: new Date()`.
5. For each milestone's notes: if `newNote` is provided and non-empty, read the current `notes` JSON array from the fetched data (default to `[]` if null/undefined), append the new note string, and set `notes` to the updated array. If `newNote` is empty or not provided, leave `notes` unchanged (do NOT include it in the update).
6. Use `prisma.$transaction()` with array of `prisma.milestone.update()` calls. For each milestone update: set `status`, `dueDate` (parse string to Date or null), conditionally `notes` (only if new note appended), and conditionally `startDate`/`completedAt` as determined above. Also recalculate and store `progress` using `calculateMilestoneProgress` from the progress utility.
7. After successful transaction, call `revalidatePath('/dashboard/progress')` and `revalidatePath('/dashboard/admin/clients/' + clientId)` to bust cache for both admin and client views.
8. Return `{ success: true }` on success, `{ error: 'Failed to update milestones' }` on catch.

Do NOT implement client notifications on milestone updates -- cache revalidation updates UI only, no email/push notifications (deferred to backlog).

Import `revalidatePath` from `next/cache`. Import `verifySession` from `@/lib/dal`. Import `prisma` from `@/lib/prisma`. Import `calculateMilestoneProgress` from `@/lib/utils/progress`. Import `z` from `zod`.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify TypeScript compiles. Verify the file contains `'use server'` directive, Zod validation, `verifySession()` call, `$transaction`, and `revalidatePath` calls.
  </verify>
  <done>
Server Action validates admin role, validates input with Zod, appends new notes to existing JSON array (preserving history), auto-sets startDate/completedAt on status transitions, batch-updates milestones in a Prisma transaction, recalculates progress percentages, and revalidates both admin and client dashboard paths.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `lib/dal.ts` has `getAllClientsWithMilestones` and `getClientWithMilestones` functions with admin role checks
- `lib/utils/progress.ts` exports `calculateMilestoneProgress` and `calculateOverallProgress`
- `app/dashboard/admin/clients/[clientId]/actions.ts` has `'use server'`, Zod schema, transaction, revalidation
- Notes handling appends to JSON array, does not replace it
</verification>

<success_criteria>
All three files compile cleanly. DAL functions enforce admin role. Server Action handles the full lifecycle: auth check, validation, status-aware date transitions, notes array appending, batch transaction, progress recalculation, and cache revalidation.
</success_criteria>

<output>
After completion, create `.planning/phases/04-admin-milestone-editing/04-01-SUMMARY.md`
</output>
