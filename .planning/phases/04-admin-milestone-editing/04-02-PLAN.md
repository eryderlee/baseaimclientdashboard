---
phase: 04-admin-milestone-editing
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/dashboard/admin/page.tsx
  - app/dashboard/admin/clients/[clientId]/page.tsx
  - components/admin/milestone-edit-table.tsx
autonomous: false

must_haves:
  truths:
    - "Admin sees list of all clients with progress and 'Edit Milestones' links"
    - "Admin clicks client link and lands on milestone editing page"
    - "Admin sees table with 6 milestones showing Name, Status, Due Date, Notes, Progress columns"
    - "Admin can change status via dropdown, due date via date input, and add notes via textarea"
    - "Admin clicks 'Save All Changes' and changes persist to database"
    - "Progress column shows auto-calculated percentage (read-only)"
    - "Client dashboard reflects updated milestones after admin saves"
  artifacts:
    - path: "app/dashboard/admin/page.tsx"
      provides: "Admin client list with Edit Milestones links"
      contains: "Edit Milestones"
    - path: "app/dashboard/admin/clients/[clientId]/page.tsx"
      provides: "Client milestone editing page with admin auth check"
      contains: "getClientWithMilestones"
    - path: "components/admin/milestone-edit-table.tsx"
      provides: "Inline-editable table for milestones with batch save"
      contains: "use client"
  key_links:
    - from: "app/dashboard/admin/page.tsx"
      to: "/dashboard/admin/clients/[clientId]"
      via: "Link component href"
      pattern: "href.*admin/clients"
    - from: "app/dashboard/admin/page.tsx"
      to: "lib/utils/progress.ts"
      via: "calculateOverallProgress for client progress column"
      pattern: "calculateOverallProgress"
    - from: "app/dashboard/admin/clients/[clientId]/page.tsx"
      to: "lib/dal.ts"
      via: "getClientWithMilestones call"
      pattern: "getClientWithMilestones"
    - from: "components/admin/milestone-edit-table.tsx"
      to: "app/dashboard/admin/clients/[clientId]/actions.ts"
      via: "updateMilestones Server Action call on save"
      pattern: "updateMilestones"
    - from: "components/admin/milestone-edit-table.tsx"
      to: "lib/utils/progress.ts"
      via: "calculateMilestoneProgress for live preview"
      pattern: "calculateMilestoneProgress"
---

<objective>
Build the admin UI for viewing clients and editing their milestones. Update the existing admin page with client links, create the milestone editing page, and build the inline-editable table component.

Purpose: This is the user-facing admin interface where the BaseAim team manages client progress. It connects the backend (Plan 01) to a table/spreadsheet-style editing experience.
Output: Updated admin dashboard with client list, new client milestone editing page, and inline-editable table component with batch save.
</objective>

<execution_context>
@C:\Users\eryde\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\eryde\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-admin-milestone-editing/04-RESEARCH.md
@.planning/phases/04-admin-milestone-editing/04-01-SUMMARY.md

@app/dashboard/admin/page.tsx
@lib/dal.ts
@lib/utils/progress.ts
@app/dashboard/admin/clients/[clientId]/actions.ts
@components/dashboard/progress-view.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update admin page and create milestone editing page</name>
  <files>app/dashboard/admin/page.tsx, app/dashboard/admin/clients/[clientId]/page.tsx</files>
  <action>
**Update `app/dashboard/admin/page.tsx`:**

Replace the existing `getAdminData` function to use the new DAL function `getAllClientsWithMilestones` instead of raw Prisma queries. Keep the existing admin stats cards (Total Clients, Total Documents, Total Messages, Total Revenue) but update the data source. The page already checks admin role -- switch to using `verifySession()` from DAL instead of raw `auth()` for consistency.

Add an "Edit Milestones" link column to the clients table. Use `Link` from `next/link` pointing to `/dashboard/admin/clients/${client.id}`. Style as a small button or text link.

Also add an "Overall Progress" column showing the percentage for each client. Import `calculateOverallProgress` from `@/lib/utils/progress`. For each client in the table, compute overall progress using `calculateOverallProgress(client.milestones)` and display the result as a percentage (e.g., "45%") in the new column. This gives admins a quick at-a-glance view of each client's project health.

Keep the existing table columns (Company, Contact, Documents, Milestones completed count, Revenue, Status, Joined) and add the new columns.

**Create `app/dashboard/admin/clients/[clientId]/page.tsx`:**

This is an async Server Component. Structure:

1. Call `verifySession()`, check `userRole === 'ADMIN'`, redirect to `/dashboard` if not admin.
2. Await `params` (Next.js 16+ async params): `const { clientId } = await params`
3. Call `getClientWithMilestones(clientId)` from DAL.
4. Serialize milestone dates to ISO strings (same pattern as progress page).
5. Render page with: back link to `/dashboard/admin`, client company name as heading, and the `MilestoneEditTable` component (from next task) receiving `clientId` and serialized milestones as props.

Use proper TypeScript types for the params: `{ params: Promise<{ clientId: string }> }`.

Import `calculateMilestoneProgress` from `@/lib/utils/progress` to compute each milestone's current progress before passing to the table component.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify both files compile. Verify the admin page has a Link to `/dashboard/admin/clients/[clientId]`. Verify the client page awaits params and calls `getClientWithMilestones`. Verify the admin page imports and uses `calculateOverallProgress`.
  </verify>
  <done>
Admin dashboard shows client list with "Edit Milestones" links and overall progress percentage per client (computed via `calculateOverallProgress`). Client milestone page loads with admin auth, fetches client data via DAL, and renders the edit table component.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build milestone edit table component with batch save</name>
  <files>components/admin/milestone-edit-table.tsx</files>
  <action>
**Create `components/admin/milestone-edit-table.tsx`:**

Mark with `'use client'` at top.

**Props interface:**
```typescript
type MilestoneData = {
  id: string
  title: string
  description: string | null
  status: 'NOT_STARTED' | 'IN_PROGRESS' | 'COMPLETED' | 'BLOCKED'
  dueDate: string | null
  startDate: string | null
  notes: unknown  // Json field from Prisma -- stored as string[] array
  progress: number
  order: number
}

interface MilestoneEditTableProps {
  clientId: string
  initialMilestones: MilestoneData[]
}
```

**State management:**
- `useState` for `milestones` array (initialized from `initialMilestones`)
- `useState` for `newNotes` record: `Record<string, string>` mapping milestone ID to the admin's new note text (initially empty strings for all milestones)
- `useState` for `hasChanges` boolean (tracks if any edits made since last save)
- `useTransition` for `isPending` state during save

**Table layout (spreadsheet-style):**
Use shadcn/ui `Table`, `TableHeader`, `TableRow`, `TableHead`, `TableBody`, `TableCell` components.

Columns:
1. **#** -- Milestone order number (read-only, from `order` field)
2. **Milestone** -- Title (read-only, bold)
3. **Status** -- Native HTML `<select>` with options: Not Started, In Progress, Completed, Blocked. Styled with Tailwind to look clean. Value bound to `milestone.status`. On change, update local state and recalculate progress using `calculateMilestoneProgress` from `@/lib/utils/progress`.
4. **Due Date** -- Native HTML `<input type="date">`. Format the ISO string to `YYYY-MM-DD` for the input value. On change, update local state and recalculate progress.
5. **Notes** -- Display existing notes from the JSON array: show the most recent note (last element of the `notes` array, cast to `string[]`) as read-only text above the input. If no existing notes, show nothing. Below that, render a `<textarea>` (NOT `<input type="text">` -- use textarea for multi-line admin notes capability) with placeholder "Add a note...". Bind the textarea value to `newNotes[milestone.id]`. The textarea is for composing a NEW note that will be appended to the array on save. Keep the textarea compact (2-3 rows) to maintain table feel.
6. **Progress** -- Read-only display showing `{progress}%` with a small colored bar or badge. Color: green for 100%, yellow for 50-99%, gray for 0%.

**IMPORTANT: Notes are a JSON array of strings.** The `notes` field from Prisma is `Json? @default("[]")`. Treat it as `string[]`. Do NOT display it as a raw string or replace it. Show the last array element as "Latest note" read-only text, and provide a textarea for adding a new note. On save, send `newNote` (singular string) per milestone -- the Server Action handles appending to the array.

Do NOT implement client notifications on milestone updates -- cache revalidation updates UI only, no email/push notifications (deferred to backlog).

**Edit affordances:**
- Status select: distinct from read-only (use a subtle border/background)
- Date input: subtle border, clickable
- Notes textarea: subtle border, placeholder text
- Hover state on editable cells (slightly darker background)

**Save behavior:**
- "Save All Changes" button at top-right of table card
- Disabled when `!hasChanges` or `isPending`
- Shows "Saving..." text when `isPending`
- On click: call `updateMilestones` Server Action with `clientId` and the milestones array. For each milestone, send `{ id, status, dueDate, newNote: newNotes[milestone.id] }`. Only include `newNote` if the admin typed something non-empty.
- On success: set `hasChanges` to false, clear all `newNotes` entries, optionally show brief success indicator
- On error: show error message (use simple alert or inline error text)

**Unsaved changes indicator:**
- When `hasChanges` is true, show a subtle "Unsaved changes" badge near the save button
- Style the save button as primary/accent when there are changes, muted when no changes

**When status changes:**
- Recalculate progress locally using `calculateMilestoneProgress(newStatus, startDate, dueDate)` so the Progress column updates immediately without saving
- If status changes to IN_PROGRESS and no startDate, use current date as startDate locally for progress preview

**Styling:**
- Wrap in a shadcn Card with CardHeader (title: "Edit Milestones") and CardContent
- Match the existing admin dashboard styling (neutral colors, clean table)
- Table should feel like a spreadsheet (compact rows, clear cell boundaries)
- Add `max-w-5xl` or similar width constraint for readability

Do NOT use TanStack Table. Simple controlled state with map is sufficient for 6 rows.
Do NOT use a modal or dialog for editing. Everything is inline in the table.
Do NOT install any new npm packages. Use existing shadcn/ui components and native HTML inputs.
  </action>
  <verify>
Run `npx tsc --noEmit` to verify the component compiles. Verify the file has `'use client'` directive, imports `updateMilestones`, uses `useTransition`, and renders a table with select, date input, textarea (not text input), and save button. Verify notes are treated as a JSON string array (last element displayed, new note sent as `newNote`).
  </verify>
  <done>
Milestone edit table renders all milestones in spreadsheet-style rows with inline status dropdown, date picker, notes textarea (showing latest note from array, with textarea for adding new note), and read-only auto-calculated progress. Save button batch-submits all changes via Server Action with `newNote` per milestone for array appending. Unsaved changes are indicated visually. No client notifications are triggered.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete admin milestone editing flow: admin dashboard with client list and links, client milestone editing page with inline table editing, batch save via Server Action, time-based progress calculation, notes append-to-array handling, and cache revalidation for client dashboard.</what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Log in as admin (admin@baseaim.com / admin123)
3. Navigate to /dashboard/admin -- verify you see "Edit Milestones" links in client table and overall progress column
4. Click "Edit Milestones" for a test client -- verify you land on the milestone editing page
5. Verify the table shows 6 milestones with columns: #, Milestone, Status, Due Date, Notes, Progress
6. Change a milestone status from "Not Started" to "In Progress" -- verify Progress column updates immediately
7. Set a due date on a milestone -- verify progress recalculates
8. Type a note in the Notes textarea and save -- verify the note appears as "Latest note" after refresh
9. Add another note to the same milestone -- verify the previous note is still shown and the new one appends
10. Click "Save All Changes" -- verify button shows "Saving..." briefly then resets
11. Refresh the page -- verify changes persisted (status, dates, notes)
12. Open a new browser/incognito, log in as the test client user -- navigate to /dashboard/progress -- verify the milestone changes are reflected in the client's view
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- Admin dashboard at /dashboard/admin shows client list with "Edit Milestones" links and overall progress per client
- Clicking link navigates to /dashboard/admin/clients/[id] with milestone table
- Table displays all 6 standard milestones with inline-editable Status, Due Date, Notes (textarea)
- Notes column shows latest existing note (from JSON array) and textarea for adding new notes
- Progress column is read-only and auto-calculates based on status and dates
- "Save All Changes" persists changes to database via Server Action
- New notes are appended to the existing JSON array, preserving note history
- Client dashboard at /dashboard/progress shows updated milestones after admin saves
- Non-admin users cannot access /dashboard/admin/clients/[id] (redirected)
- No client notifications are sent on milestone updates (deferred to backlog)
- TypeScript compiles with no errors: `npx tsc --noEmit`
</verification>

<success_criteria>
Admin can navigate from admin dashboard to any client's milestone editing page, make changes to status/dates across multiple milestones, add notes (appended to history array), save all changes in one click, and the client sees the updates immediately in their own dashboard. Progress percentages auto-calculate without manual entry. Existing notes data is preserved, not overwritten.
</success_criteria>

<output>
After completion, create `.planning/phases/04-admin-milestone-editing/04-02-SUMMARY.md`
</output>
