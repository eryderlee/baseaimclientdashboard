---
phase: 06-admin-analytics
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/admin/page.tsx
  - components/admin/client-analytics-table.tsx
  - components/admin/client-filters.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees dashboard with all clients and their overall progress percentages"
    - "Admin can identify at-risk projects (overdue milestones, stalled progress) via visual indicators"
    - "Admin can filter clients by status (all, active, inactive, at-risk)"
    - "Admin can sort clients by name, progress, or next due date"
    - "Admin sees summary metrics (total clients, average progress, at-risk count, upcoming due dates)"
  artifacts:
    - path: "app/admin/page.tsx"
      provides: "Enhanced admin dashboard with analytics and filtering"
      contains: "AnalyticsSummary"
    - path: "components/admin/client-analytics-table.tsx"
      provides: "Interactive client table with filtering, sorting, and risk indicators"
      exports: ["ClientAnalyticsTable"]
    - path: "components/admin/client-filters.tsx"
      provides: "Filter and sort controls using URL search params"
      exports: ["ClientFilters"]
  key_links:
    - from: "app/admin/page.tsx"
      to: "lib/dal.ts"
      via: "getAdminAnalytics call"
      pattern: "getAdminAnalytics"
    - from: "app/admin/page.tsx"
      to: "components/admin/analytics-summary.tsx"
      via: "AnalyticsSummary component"
      pattern: "AnalyticsSummary"
    - from: "components/admin/client-analytics-table.tsx"
      to: "components/admin/at-risk-indicator.tsx"
      via: "RiskBadge in table rows"
      pattern: "RiskBadge"
    - from: "components/admin/client-filters.tsx"
      to: "components/admin/client-analytics-table.tsx"
      via: "URL search params read by table"
      pattern: "useSearchParams"
---

<objective>
Integrate analytics components into the admin dashboard with interactive filtering and sorting.

Purpose: Transform the admin page from a basic client list into a full analytics dashboard where admin can filter, sort, and identify at-risk clients at a glance.
Output: Enhanced admin page with analytics summary, filterable/sortable client table with risk indicators.
</objective>

<execution_context>
@C:\Users\eryde\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\eryde\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-admin-analytics/06-RESEARCH.md
@.planning/phases/06-admin-analytics/06-01-SUMMARY.md

@app/admin/page.tsx
@lib/dal.ts
@lib/utils/risk-detection.ts
@components/admin/analytics-summary.tsx
@components/admin/at-risk-indicator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Client filters and analytics table components</name>
  <files>components/admin/client-filters.tsx, components/admin/client-analytics-table.tsx</files>
  <action>
    Create `components/admin/client-filters.tsx`:
    - 'use client' component
    - Import useSearchParams, useRouter, usePathname from 'next/navigation'
    - Export `ClientFilters` component
    - Render two Select dropdowns (shadcn Select component) in a flex row with gap-4:
      1. Status filter: "All Clients", "Active Only", "Inactive", "At Risk" (values: 'all', 'active', 'inactive', 'at-risk')
      2. Sort by: "Name", "Progress", "Next Due Date" (values: 'name', 'progress', 'due-date')
    - Read current values from searchParams.get('status') and searchParams.get('sort'), default to 'all' and 'name'
    - On change, update URL params using router.push with new URLSearchParams. Delete param if value is default ('all' for status, 'name' for sort)
    - Wrap in Suspense boundary consideration: the parent page should wrap this in Suspense

    Create `components/admin/client-analytics-table.tsx`:
    - 'use client' component
    - Export `ClientAnalyticsTable` component
    - Accept props: `{ clients: Array<serialized client data with milestones, risk info, overallProgress, nextDueDate> }`
    - The client type should include: id, companyName, isActive, overallProgress (number), completedMilestones (number), totalMilestones (number), riskLevel ('none'|'low'|'medium'|'high'), riskReasons (string[]), nextDueDate (string|null), user: { name, email }, createdAt (string)
    - Import useSearchParams from 'next/navigation'
    - Use useMemo to filter and sort clients based on URL search params:
      - status='active' -> filter isActive === true
      - status='inactive' -> filter isActive === false
      - status='at-risk' -> filter riskLevel !== 'none'
      - sort='name' -> localeCompare on companyName
      - sort='progress' -> sort by overallProgress descending
      - sort='due-date' -> sort by nextDueDate ascending (null dates last)
    - Render shadcn Table with columns: Company, Contact, Milestones (completed/total), Progress (progress bar + percentage, reuse pattern from current admin page), Risk (RiskBadge component), Status (Active/Inactive Badge), Next Due Date, Actions (Edit, Milestones links + StatusToggleButton - preserve existing action buttons)
    - Handle empty filtered results: show a centered message "No clients match the current filters" with a "Clear Filters" button that removes all URL params
    - Import RiskBadge from components/admin/at-risk-indicator
    - Import StatusToggleButton from components/admin/status-toggle-button
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
  </verify>
  <done>
    ClientFilters renders two Select dropdowns that update URL search params.
    ClientAnalyticsTable filters and sorts clients based on URL params, shows risk badges, handles empty state.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate analytics into admin page</name>
  <files>app/admin/page.tsx</files>
  <action>
    Rewrite `app/admin/page.tsx` to integrate all analytics components:

    - Keep as async Server Component
    - Import getAdminAnalytics from lib/dal (new), keep getAllClientsWithMilestones
    - Import detectClientRisk from lib/utils/risk-detection
    - Import calculateOverallProgress from lib/utils/progress
    - Import AnalyticsSummary from components/admin/analytics-summary
    - Import ClientFilters from components/admin/client-filters
    - Import ClientAnalyticsTable from components/admin/client-analytics-table
    - Import Suspense from React (for wrapping client components that use useSearchParams)

    Data fetching (in getAdminData or inline):
    - Call getAdminAnalytics() for summary metrics
    - Call getAllClientsWithMilestones() for client list
    - For each client, compute: overallProgress (calculateOverallProgress), risk (detectClientRisk), completedMilestones count, nextDueDate (earliest non-COMPLETED milestone dueDate)
    - Serialize dates to ISO strings for client component transport
    - Prepare upcomingDueDates as serialized array for AnalyticsSummary

    Page layout (top to bottom):
    1. Header: "Admin Dashboard" title + "Add Client" button (keep existing)
    2. AnalyticsSummary component with metrics from getAdminAnalytics (replace old 4 stat cards)
    3. Card containing:
       - CardHeader: "All Clients" title + CardDescription
       - ClientFilters wrapped in Suspense with fallback
       - ClientAnalyticsTable wrapped in Suspense with fallback, passing serialized client data

    Remove the old inline client table and old stat cards (Total Documents, Total Messages, Total Revenue) - these are replaced by analytics-focused cards. Keep the "Add Client" button in header.

    IMPORTANT: Wrap ClientFilters and ClientAnalyticsTable in `<Suspense fallback={<div>Loading...</div>}>` because they use useSearchParams which requires Suspense boundary in Next.js App Router.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Run `npm run build` to verify the page builds successfully (Server Component with client component children).
    Start dev server and visit /admin to verify:
    - Summary cards show correct metrics
    - Client table renders with risk indicators
    - Filtering by status works (URL updates)
    - Sorting by name/progress/due-date works
    - Empty state shows when filtering yields no results
    - Existing action buttons (Edit, Milestones, Status toggle) still work
  </verify>
  <done>
    Admin dashboard shows analytics summary cards (total clients, average progress, at-risk count, upcoming due dates).
    Client table displays risk badges per client.
    Filters (status) and sorts (name, progress, due date) work via URL search params.
    Empty filter state handled with clear message.
    All existing functionality (edit, milestones, status toggle) preserved.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `npm run build` succeeds
- Admin page at /admin loads with analytics summary and enhanced client table
- Filter dropdowns update URL and filter table content
- Sort changes reorder table correctly
- Risk badges appear for clients with overdue or stalled milestones
- Existing action buttons (Edit, Milestones, Status toggle) function correctly
- Empty filter state shows appropriate message
</verification>

<success_criteria>
- Admin sees 4 analytics-focused stat cards (total clients, average progress, at-risk, upcoming due dates)
- Admin can filter clients by All/Active/Inactive/At Risk via dropdown
- Admin can sort clients by Name/Progress/Next Due Date via dropdown
- At-risk clients show colored risk badges with severity levels
- URL search params persist filter/sort state across page loads
- All pre-existing admin functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/06-admin-analytics/06-02-SUMMARY.md`
</output>
