---
phase: 06-admin-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/utils/risk-detection.ts
  - lib/dal.ts
  - components/admin/analytics-summary.tsx
  - components/admin/at-risk-indicator.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees summary metrics (total clients, active clients, average progress, at-risk count, upcoming due dates)"
    - "Admin can identify at-risk projects via overdue milestones and stalled progress detection"
  artifacts:
    - path: "lib/utils/risk-detection.ts"
      provides: "Risk detection logic for clients based on milestone data"
      exports: ["detectClientRisk", "RiskIndicators"]
    - path: "lib/dal.ts"
      provides: "Analytics data aggregation function"
      exports: ["getAdminAnalytics"]
    - path: "components/admin/analytics-summary.tsx"
      provides: "Summary metric cards for admin dashboard"
      exports: ["AnalyticsSummary"]
    - path: "components/admin/at-risk-indicator.tsx"
      provides: "Risk badge component for client table rows"
      exports: ["RiskBadge"]
  key_links:
    - from: "lib/dal.ts"
      to: "lib/utils/risk-detection.ts"
      via: "import detectClientRisk"
      pattern: "detectClientRisk"
    - from: "components/admin/analytics-summary.tsx"
      to: "lib/utils/risk-detection.ts"
      via: "RiskIndicators type"
      pattern: "RiskIndicators"
---

<objective>
Build the backend analytics layer and reusable UI components for the admin analytics dashboard.

Purpose: Provide the data aggregation, risk detection logic, and display components that Plan 02 will integrate into the admin page.
Output: Risk detection utility, DAL analytics function, summary cards component, and risk badge component.
</objective>

<execution_context>
@C:\Users\eryde\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\eryde\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-admin-analytics/06-RESEARCH.md

@lib/dal.ts
@lib/utils/progress.ts
@app/admin/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Risk detection utility and DAL analytics function</name>
  <files>lib/utils/risk-detection.ts, lib/dal.ts</files>
  <action>
    Create `lib/utils/risk-detection.ts` with:
    - Export `RiskIndicators` interface: `{ isAtRisk: boolean, riskLevel: 'none' | 'low' | 'medium' | 'high', reasons: string[] }`
    - Export `detectClientRisk(client)` function that accepts a client object with milestones array (each milestone has status, dueDate, startDate, progress fields)
    - Overdue detection: Any non-COMPLETED milestone with dueDate before now = risk. 1 overdue = 'medium', 2+ overdue = 'high'
    - Stalled detection: IN_PROGRESS milestone started 14+ days ago with progress < 50 = stalled. Stalled alone = 'low', stalled + overdue = 'high'
    - No BLOCKED status check needed (BLOCKED is not in the MilestoneStatus enum based on schema)
    - Use `differenceInDays` from `date-fns` (already installed) for date math
    - Return reasons array with human-readable strings like "1 overdue milestone(s)", "1 stalled milestone(s)"

    Add to `lib/dal.ts`:
    - Export `getAdminAnalytics` function wrapped in `cache()` following existing DAL pattern
    - Must call `verifySession()` and check `userRole === 'ADMIN'`
    - Call `getAllClientsWithMilestones()` to get client data (reuses existing cached function)
    - Calculate: totalClients, activeClients, averageProgress (using calculateOverallProgress from lib/utils/progress.ts), atRiskClients count (using detectClientRisk)
    - Calculate upcomingDueDates: milestones due within 7 days that are NOT COMPLETED, mapped to `{ clientName: string, milestoneTitle: string, dueDate: Date }`
    - Calculate totalMilestones and completedMilestones counts
    - Return all metrics as a typed object
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Verify risk-detection.ts exports are importable from dal.ts.
  </verify>
  <done>
    detectClientRisk correctly identifies overdue and stalled milestones with appropriate risk levels.
    getAdminAnalytics returns all aggregate metrics (totalClients, activeClients, averageProgress, atRiskClients, upcomingDueDates, totalMilestones, completedMilestones).
  </done>
</task>

<task type="auto">
  <name>Task 2: Analytics summary cards and risk badge components</name>
  <files>components/admin/analytics-summary.tsx, components/admin/at-risk-indicator.tsx</files>
  <action>
    Create `components/admin/at-risk-indicator.tsx`:
    - Server component (no 'use client' needed)
    - Export `RiskBadge({ level }: { level: 'none' | 'low' | 'medium' | 'high' })` component
    - Return null for 'none' level
    - Use shadcn Badge component with variants: low = 'secondary' with yellow text, medium = 'outline' with orange text, high = 'destructive'
    - Include AlertTriangle icon from lucide-react (h-3 w-3) before label text
    - Labels: 'Low Risk', 'At Risk', 'High Risk'

    Create `components/admin/analytics-summary.tsx`:
    - Server component (no 'use client')
    - Export `AnalyticsSummary` that accepts props: `{ totalClients: number, activeClients: number, averageProgress: number, atRiskClients: number, upcomingDueDates: Array<{ clientName: string, milestoneTitle: string, dueDate: string }> }`
    - Note: dueDate is string (ISO) because dates are serialized for server-to-client transport
    - Render 4 stat cards in a grid (md:grid-cols-2 lg:grid-cols-4) using shadcn Card:
      1. Total Clients (Users icon) with "{activeClients} active" subtitle
      2. Average Progress (TrendingUp icon) with "{averageProgress}%" as main number and a small progress bar
      3. At Risk (AlertTriangle icon) with count, use destructive text color if > 0
      4. Upcoming Due Dates (Calendar icon) with count of items due in next 7 days
    - Below the cards, if upcomingDueDates.length > 0, render a small list of upcoming items showing client name, milestone title, and formatted date
    - Follow existing card pattern from app/admin/page.tsx (CardHeader with icon, CardContent with number + subtitle)
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no TypeScript errors.
    Verify both components import correctly.
  </verify>
  <done>
    RiskBadge renders appropriate colored badge with icon for each risk level, returns null for 'none'.
    AnalyticsSummary renders 4 metric cards with correct data display and optional upcoming due dates list.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- All new files exist and export expected symbols
- Risk detection logic handles edge cases (no milestones, no dates, all completed)
</verification>

<success_criteria>
- lib/utils/risk-detection.ts exports detectClientRisk and RiskIndicators
- lib/dal.ts exports getAdminAnalytics with all aggregate metrics
- components/admin/analytics-summary.tsx renders 4 metric cards
- components/admin/at-risk-indicator.tsx renders risk badges by level
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-admin-analytics/06-01-SUMMARY.md`
</output>
