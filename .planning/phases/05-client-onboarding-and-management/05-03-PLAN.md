---
phase: 05-client-onboarding-and-management
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - app/admin/clients/[clientId]/edit/page.tsx
  - app/admin/page.tsx
  - components/admin/client-form.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can navigate to edit page for any client from admin dashboard"
    - "Edit form pre-fills with existing client data"
    - "Admin can update client name, company name, and optional fields"
    - "Admin can deactivate a client account from the admin dashboard"
    - "Admin can reactivate a previously deactivated client account"
    - "Deactivated clients show inactive badge and reactivate option"
  artifacts:
    - path: "app/admin/clients/[clientId]/edit/page.tsx"
      provides: "Client edit page reusing ClientForm in edit mode"
      contains: "ClientForm"
    - path: "app/admin/page.tsx"
      provides: "Admin dashboard with Edit and Deactivate/Reactivate actions per client"
      contains: "toggleClientStatus"
  key_links:
    - from: "app/admin/clients/[clientId]/edit/page.tsx"
      to: "lib/dal.ts"
      via: "getClientForEdit(clientId)"
      pattern: "getClientForEdit"
    - from: "app/admin/clients/[clientId]/edit/page.tsx"
      to: "components/admin/client-form.tsx"
      via: "ClientForm mode='edit' with defaultValues"
      pattern: "mode.*edit"
    - from: "app/admin/page.tsx"
      to: "app/admin/actions.ts"
      via: "toggleClientStatus Server Action"
      pattern: "toggleClientStatus"
---

<objective>
Build client editing and account management: edit page that reuses ClientForm in edit mode with pre-filled data, and deactivate/reactivate toggle on the admin dashboard client table.

Purpose: Completes the client management lifecycle -- admin can not only create clients but also update their information and control account access.
Output: Working edit flow and status toggle, completing all Phase 5 success criteria.
</objective>

<execution_context>
@C:\Users\eryde\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\eryde\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-client-onboarding-and-management/05-RESEARCH.md
@.planning/phases/05-client-onboarding-and-management/05-01-SUMMARY.md
@.planning/phases/05-client-onboarding-and-management/05-02-SUMMARY.md
@lib/dal.ts
@app/admin/actions.ts
@components/admin/client-form.tsx
@app/admin/page.tsx
@app/admin/clients/[clientId]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build client edit page and add edit/status actions to admin dashboard</name>
  <files>
    app/admin/clients/[clientId]/edit/page.tsx
    app/admin/page.tsx
  </files>
  <action>
    1. Create `app/admin/clients/[clientId]/edit/page.tsx`:
       - Async server component
       - Verify admin role via `verifySession()`, redirect to `/dashboard` if not admin
       - Await params: `const { clientId } = await params`
       - Fetch client data via `getClientForEdit(clientId)` from DAL
       - Layout: Back button to `/admin` (same pattern as milestone edit page)
       - Heading: "Edit Client - {client.companyName}"
       - Subtext: "Update client details and company information"
       - Render `<ClientForm mode="edit" clientId={clientId} defaultValues={{ name: client.user.name, companyName: client.companyName, industry: client.industry ?? '', website: client.website ?? '', phone: client.phone ?? '', address: client.address ?? '' }} />`

    2. Update `app/admin/page.tsx` client table:
       - Replace single "Edit Milestones" button with a cell containing multiple action buttons
       - Add three action buttons per client row:
         a. "Edit" button (Pencil icon) linking to `/admin/clients/${client.id}/edit` -- use `variant="outline" size="sm"`
         b. "Milestones" button (ListChecks icon) linking to `/admin/clients/${client.id}` -- use `variant="outline" size="sm"` (existing link, just renamed)
         c. Deactivate/Reactivate button -- extract this to a client component `StatusToggleButton` defined inline or at bottom of file

       **StatusToggleButton implementation:**
       - `'use client'` component accepting `clientId: string` and `isActive: boolean`
       - Import `toggleClientStatus` from `@/app/admin/actions`
       - Import `toast` from `sonner`
       - On click: call `toggleClientStatus(clientId)`, show `toast.success()` or `toast.error()` based on result
       - Use `useTransition` for pending state (disable button while toggling)
       - Render: if active, show red "Deactivate" text button; if inactive, show green "Activate" text button
       - Use `variant="ghost" size="sm"` styling

       Create `StatusToggleButton` as a separate client component file at `components/admin/status-toggle-button.tsx` since the admin page is a server component and cannot have onClick handlers.

       - Import `Pencil, ListChecks` from lucide-react
       - Wrap action buttons in `<div className="flex items-center gap-1">`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run build` completes without errors
  </verify>
  <done>
    - /admin/clients/[clientId]/edit page renders ClientForm pre-filled with client data
    - Admin dashboard shows Edit, Milestones, and Deactivate/Activate buttons per client
    - Toggling status updates database and refreshes admin table
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete client onboarding and management flow:
    1. Backend: Server Actions for create/update/toggle with Zod validation and Prisma transactions
    2. Client creation form with React Hook Form validation and password generation
    3. Client edit page with pre-filled form
    4. Deactivate/reactivate toggle on admin dashboard
  </what-built>
  <how-to-verify>
    1. Log in as admin (admin@baseaim.com / admin123)
    2. On admin dashboard, click "Add Client" button
    3. Try submitting empty form -- verify validation errors appear
    4. Click "Generate" next to password field -- verify password is generated
    5. Fill in: Name "Test User", Email "test@example.com", Company "Test Co", password generated
    6. Submit -- verify redirect to admin dashboard with new client in table
    7. Click "Edit" on the new client row
    8. Change company name to "Test Company Updated", click Save
    9. Verify toast shows success and data is updated
    10. Back on admin dashboard, click "Deactivate" on the test client
    11. Verify badge changes to "Inactive" and button changes to "Activate"
    12. Open new browser/incognito, try logging in as test@example.com -- verify dashboard loads with 6 milestones showing "Not Started"
    13. Back as admin, click "Activate" to reactivate
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds with no errors
- Full client lifecycle works: create -> view in list -> edit details -> deactivate -> reactivate
- New client has 6 standard milestones initialized
- Form validation prevents invalid submissions
- Toast notifications provide feedback on all actions
</verification>

<success_criteria>
- Admin can add new client with company name, contact info, and login credentials
- Admin can edit client details after creation
- Admin can deactivate/reactivate client accounts
- New clients automatically get standard 6-milestone template
- All actions provide clear feedback via toast notifications
</success_criteria>

<output>
After completion, create `.planning/phases/05-client-onboarding-and-management/05-03-SUMMARY.md`
</output>
