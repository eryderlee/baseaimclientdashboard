---
phase: 05-client-onboarding-and-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/schemas/client.ts
  - app/admin/actions.ts
  - lib/dal.ts
  - lib/utils/password.ts
  - app/layout.tsx
  - package.json
autonomous: true

must_haves:
  truths:
    - "Zod schemas validate client creation and update inputs with proper error messages"
    - "Server Action creates User + Client + 6 standard milestones atomically in a transaction"
    - "Server Action updates client details with proper validation"
    - "Server Action toggles client active/inactive status"
    - "DAL function fetches single client with user details for editing"
    - "Sonner Toaster is mounted in root layout for toast notifications"
  artifacts:
    - path: "lib/schemas/client.ts"
      provides: "Zod schemas for createClient and updateClient"
      exports: ["createClientSchema", "updateClientSchema", "CreateClientInput", "UpdateClientInput"]
    - path: "app/admin/actions.ts"
      provides: "Server Actions for client CRUD"
      exports: ["createClient", "updateClient", "toggleClientStatus"]
    - path: "lib/dal.ts"
      provides: "getClientForEdit DAL function"
      exports: ["getClientForEdit"]
    - path: "lib/utils/password.ts"
      provides: "Secure password generation utility"
      exports: ["generateSecurePassword"]
    - path: "app/layout.tsx"
      provides: "Sonner Toaster mounted in root layout"
      contains: "Toaster"
  key_links:
    - from: "app/admin/actions.ts"
      to: "lib/schemas/client.ts"
      via: "import createClientSchema, updateClientSchema"
      pattern: "import.*from.*schemas/client"
    - from: "app/admin/actions.ts"
      to: "prisma.$transaction"
      via: "atomic User+Client+Milestone creation"
      pattern: "prisma\\.\\$transaction"
    - from: "app/admin/actions.ts"
      to: "lib/utils/progress"
      via: "reuses STANDARD_MILESTONES template"
      pattern: "STANDARD_MILESTONES"
---

<objective>
Create the backend foundation for client onboarding: Zod validation schemas, Server Actions for client CRUD (create with atomic transaction, update, toggle status), DAL query for edit page, password generation utility, and Sonner toast infrastructure.

Purpose: All client management UI in subsequent plans depends on validated schemas, working Server Actions, and toast feedback. Building backend first ensures UI plans can wire directly to tested actions.
Output: Validation schemas, 3 Server Actions, 1 DAL function, password utility, Toaster in layout.
</objective>

<execution_context>
@C:\Users\eryde\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\eryde\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-client-onboarding-and-management/05-RESEARCH.md
@prisma/schema.prisma
@prisma/seed-milestones.ts
@lib/dal.ts
@app/admin/clients/[clientId]/actions.ts
@app/layout.tsx
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies, add Toaster, create Zod schemas and password utility</name>
  <files>
    package.json
    app/layout.tsx
    lib/schemas/client.ts
    lib/utils/password.ts
  </files>
  <action>
    1. Install dependencies:
       ```
       npm install react-hook-form @hookform/resolvers sonner
       ```

    2. Add Sonner Toaster to `app/layout.tsx`:
       - Import `{ Toaster }` from `'sonner'`
       - Add `<Toaster position="top-right" />` inside `<body>` after `{children}`

    3. Create `lib/schemas/client.ts` with two Zod schemas:

       **createClientSchema:**
       - `name`: string, min 2 chars ("Name must be at least 2 characters")
       - `email`: string, email format ("Enter a valid email address")
       - `password`: string, min 8 chars ("Password must be at least 8 characters")
       - `companyName`: string, min 2 chars ("Company name is required")
       - `industry`: string, optional
       - `website`: string, url format, optional, OR empty string (use `.or(z.literal(''))`)
       - `phone`: string, optional
       - `address`: string, optional

       **updateClientSchema:**
       - Same fields as createClientSchema EXCEPT: no password field, no email field
       - `name`: string, min 2 chars
       - `companyName`: string, min 2 chars
       - `industry`, `website`, `phone`, `address`: same optionals

       Export both schemas and their inferred types (`CreateClientInput`, `UpdateClientInput`).

    4. Create `lib/utils/password.ts`:
       - Export `generateSecurePassword(length: number = 12): string`
       - Must include at least one lowercase, uppercase, digit, and symbol (!@#$%^&*)
       - Fill remaining chars from combined charset
       - Shuffle the result using Fisher-Yates algorithm (NOT Math.random sort which is biased)
       - Use `crypto.getRandomValues` for secure randomness instead of `Math.random`
  </action>
  <verify>
    - `npm ls react-hook-form @hookform/resolvers sonner` shows installed packages
    - `npx tsc --noEmit` passes with no type errors in new files
  </verify>
  <done>
    - Sonner Toaster renders in root layout
    - createClientSchema and updateClientSchema export valid Zod schemas with proper error messages
    - generateSecurePassword produces 12-char passwords with all character classes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Server Actions and DAL function for client management</name>
  <files>
    app/admin/actions.ts
    lib/dal.ts
  </files>
  <action>
    1. Create `app/admin/actions.ts` with `'use server'` directive containing three Server Actions:

       **createClient(formData: FormData):**
       - Verify admin role via `verifySession()`, return `{ error: 'Unauthorized' }` if not admin
       - Extract fields from FormData and validate with `createClientSchema.safeParse()`
       - Return `{ error: 'Validation failed', errors: fieldErrors }` if invalid
       - Check for existing user by email via `prisma.user.findUnique({ where: { email } })`
       - Return `{ error: 'A user with this email already exists' }` if found
       - Hash password with `bcrypt.hash(password, 10)` BEFORE the transaction (avoid slow ops inside tx)
       - Use `prisma.$transaction(async (tx) => { ... })` to atomically:
         a. `tx.user.create()` with email, name, hashedPassword, role: 'CLIENT'
         b. `tx.client.create()` with userId, companyName, industry, website, phone, address, isActive: true
         c. Create 6 milestones using STANDARD_MILESTONES array from `@/prisma/seed-milestones` -- map over STANDARD_MILESTONES and call `tx.milestone.create()` for each with clientId, title, description, order, status, progress, dueDate, notes
       - After transaction: `revalidatePath('/admin')` and `redirect('/admin')`
       - Wrap in try/catch, return `{ error: 'Failed to create client. Please try again.' }` on failure
       - NOTE: Do NOT import the `seedStandardMilestones` function (it uses its own PrismaClient, not the transaction client). Import `STANDARD_MILESTONES` array directly and create milestones inside the transaction.

       **updateClient(clientId: string, formData: FormData):**
       - Verify admin role
       - Extract and validate with `updateClientSchema.safeParse()`
       - `prisma.client.update({ where: { id: clientId }, data: validatedFields.data })`
       - Also update user name: `prisma.user.update({ where: { id: client.userId }, data: { name } })`
       - Use a transaction for both updates
       - `revalidatePath('/admin')` and `revalidatePath('/admin/clients/${clientId}/edit')`
       - Return `{ success: true }` or `{ error: string }`

       **toggleClientStatus(clientId: string):**
       - Verify admin role
       - Fetch current client: `prisma.client.findUnique({ where: { id: clientId }, select: { isActive: true } })`
       - Toggle: `prisma.client.update({ where: { id: clientId }, data: { isActive: !current.isActive } })`
       - `revalidatePath('/admin')`
       - Return `{ success: true, isActive: !current.isActive }` or `{ error: string }`

    2. Add `getClientForEdit` to `lib/dal.ts`:
       - Wrap with `cache()`
       - Verify admin role via `verifySession()`
       - Query: `prisma.client.findUnique({ where: { id: clientId }, include: { user: { select: { name, email } } } })`
       - Throw error if not found
       - Return client with user details
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - All three Server Actions are exported from `app/admin/actions.ts`
    - `getClientForEdit` is exported from `lib/dal.ts`
  </verify>
  <done>
    - createClient atomically creates User + Client + 6 milestones in one transaction
    - updateClient updates client details and user name
    - toggleClientStatus flips isActive boolean
    - getClientForEdit returns client with user info for edit form
    - All actions validate input with Zod and verify admin role
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no errors
- `npm ls react-hook-form @hookform/resolvers sonner` shows all three packages installed
- All exports exist: createClientSchema, updateClientSchema, CreateClientInput, UpdateClientInput, createClient, updateClient, toggleClientStatus, getClientForEdit, generateSecurePassword
</verification>

<success_criteria>
- Three Server Actions handle create/update/toggle with proper validation and error handling
- Client creation uses Prisma $transaction for atomic User+Client+Milestones creation
- Password hashing happens BEFORE transaction (not inside)
- Zod schemas provide clear validation messages for form fields
- Sonner Toaster is mounted and ready for toast notifications
</success_criteria>

<output>
After completion, create `.planning/phases/05-client-onboarding-and-management/05-01-SUMMARY.md`
</output>
